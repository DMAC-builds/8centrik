"use client"

import { useState } from "react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { Progress } from "@/components/ui/progress"
import { ShoppingCart, RefreshCw } from "lucide-react"

const mockMealPlan = {
  Monday: {
    breakfast: "Berry Smoothie Bowl",
    lunch: "Salmon Salad",
    snack: "Apple with Almond Butter",
    dinner: "Grass-fed Beef with Roasted Vegetables",
  },
  Tuesday: {
    breakfast: "Scrambled Eggs with Spinach",
    lunch: "Chicken Avocado Bowl",
    snack: "Mixed Berries",
    dinner: "Baked Cod with Asparagus",
  },
  Wednesday: {
    breakfast: "Coconut Yogurt with Berries",
    lunch: "Turkey Lettuce Wraps",
    snack: "Cucumber with Hummus",
    dinner: "Grilled Chicken with Broccoli",
  },
  Thursday: {
    breakfast: "Avocado Toast (Grain-free)",
    lunch: "Sardine Salad",
    snack: "Handful of Nuts",
    dinner: "Lamb Chops with Cauliflower Mash",
  },
  Friday: {
    breakfast: "Green Smoothie",
    lunch: "Tuna Poke Bowl",
    snack: "Celery with Almond Butter",
    dinner: "Salmon with Sweet Potato",
  },
}

const groceryItems = [
  "Wild-caught salmon (2 lbs)",
  "Grass-fed ground beef (1 lb)",
  "Free-range chicken breast (2 lbs)",
  "Organic spinach (2 bags)",
  "Mixed berries (3 containers)",
  "Avocados (6 pieces)",
  "Sweet potatoes (4 pieces)",
  "Broccoli (2 heads)",
  "Asparagus (2 bunches)",
  "Almond butter (1 jar)",
  "Coconut oil (1 jar)",
  "Free-range eggs (1 dozen)",
]

export function MealPlanner() {
  const [mealPlan, setMealPlan] = useState<any>(null)
  const [isGenerating, setIsGenerating] = useState(false)
  const [showGroceryModal, setShowGroceryModal] = useState(false)
  const [orderProgress, setOrderProgress] = useState(0)
  const [isOrdering, setIsOrdering] = useState(false)

  const generateMealPlan = async () => {
    setIsGenerating(true)
    // Request AI to generate meal plan
    const response = await fetch("http://localhost:3001/api/meal-plan/ai-generate", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ preferences: { user: "active", goal: "healthy" } }),
    });

    const data = await response.json();
    setMealPlan(data.mealPlan)
    setIsGenerating(false)
  }

  const [orderData, setOrderData] = useState<any>(null)

  const orderGroceries = async () => {
    setIsOrdering(true)
    setOrderProgress(0)

    // Simulate progress updates
    const progressInterval = setInterval(() => {
      setOrderProgress(prev => {
        if (prev >= 90) {
          clearInterval(progressInterval)
          return prev
        }
        return prev + 10
      })
    }, 300)

    try {
      // Send order request to MCP server with real cart integration
      const response = await fetch("http://localhost:3001/api/orders", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          userId: "demo-user-123",
          items: groceryItems,
          storeId: "70100444" // Default store ID
        })
      });

      const data = await response.json();

      if (data.success) {
        setOrderProgress(100)
        setOrderData({
          success: true,
          orderId: `KRO-${Date.now()}`,
          message: data.message,
          cartUrl: data.cartUrl,
          estimatedDelivery: "2 hours",
          storeInfo: {
            name: "Kroger Marketplace",
            address: "456 Oak Ave, Austin, TX 78702"
          }
        })
        
        // Auto-open Kroger cart with actual items
        if (data.cartUrl) {
          setTimeout(() => {
            window.open(data.cartUrl, '_blank')
          }, 1500)
        }
      } else {
        console.error("Failed to place order", data.error);
        alert(data.error || "Failed to place order. Please check your Kroger connection.")
      }
    } catch (error) {
      console.error("Order error:", error)
      alert("Network error. Please try again.")
    }

    clearInterval(progressInterval)
    setIsOrdering(false)
  }

  return (
    <div className="p-4 space-y-6">
      <h1 className="text-2xl font-bold text-gray-800 text-center">Meal Planner</h1>

      {!mealPlan ? (
        <Card>
          <CardHeader>
            <CardTitle className="text-center">Let us plan your meals</CardTitle>
          </CardHeader>
          <CardContent className="text-center space-y-4">
            {isGenerating ? (
              <div>
                <div className="animate-spin w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p className="text-gray-600">Thinking through your energy needs...</p>
              </div>
            ) : (
              <div>
                <p className="text-gray-600 mb-4">
                  We'll create a personalized meal plan based on your health goals and preferences.
                </p>
                <Button onClick={generateMealPlan} className="bg-green-600 hover:bg-green-700">
                  <RefreshCw className="w-4 h-4 mr-2" />
                  Generate My Meal Plan
                </Button>
              </div>
            )}
          </CardContent>
        </Card>
      ) : (
        <div className="space-y-4">
          {/* Meal Plan Grid */}
          <div className="space-y-3">
            {Object.entries(mealPlan).map(([day, meals]: [string, any]) => (
              <Card key={day}>
                <CardHeader>
                  <CardTitle className="text-lg text-green-700">{day}</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-2 gap-3 text-sm">
                    <div>
                      <strong>Breakfast:</strong> {meals.breakfast}
                    </div>
                    <div>
                      <strong>Lunch:</strong> {meals.lunch}
                    </div>
                    <div>
                      <strong>Snack:</strong> {meals.snack}
                    </div>
                    <div>
                      <strong>Dinner:</strong> {meals.dinner}
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>

          {/* Order Groceries Button */}
          <Button onClick={() => setShowGroceryModal(true)} className="w-full bg-blue-600 hover:bg-blue-700 py-3">
            <ShoppingCart className="w-4 h-4 mr-2" />
            Order Groceries
          </Button>

          <Button onClick={generateMealPlan} variant="outline" className="w-full">
            <RefreshCw className="w-4 h-4 mr-2" />
            Generate New Plan
          </Button>
        </div>
      )}

      {/* Grocery Modal */}
      <Dialog open={showGroceryModal} onOpenChange={setShowGroceryModal}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle>Order Groceries</DialogTitle>
          </DialogHeader>
          <div className="space-y-4">
            {orderData ? (
              <div className="text-center space-y-4">
                <div className="text-4xl">âœ…</div>
                <div>
                  <h3 className="text-lg font-semibold text-green-700 mb-2">Order Placed Successfully!</h3>
                  <p className="text-sm text-gray-600 mb-2">Order ID: {orderData.orderId}</p>
                  <p className="text-sm text-gray-600 mb-4">Estimated Delivery: {orderData.estimatedDelivery}</p>
                  <div className="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                    <p className="font-medium text-green-800">{orderData.storeInfo?.name}</p>
                    <p className="text-sm text-green-600">{orderData.storeInfo?.address}</p>
                    <p className="text-lg font-bold text-green-700 mt-2">Total: {orderData.total}</p>
                  </div>
                </div>
                <div className="flex space-x-2">
                  <Button 
                    onClick={() => orderData.cartUrl && window.open(orderData.cartUrl, '_blank')} 
                    className="flex-1 bg-orange-600 hover:bg-orange-700"
                  >
                    View Kroger Cart
                  </Button>
                  <Button 
                    variant="outline" 
                    onClick={() => {
                      setOrderData(null)
                      setShowGroceryModal(false)
                    }} 
                    className="flex-1"
                  >
                    Close
                  </Button>
                </div>
              </div>
            ) : isOrdering ? (
              <div className="text-center space-y-4">
                <div className="animate-bounce">ðŸ›’</div>
                <p>Placing order with Kroger...</p>
                <Progress value={orderProgress} />
                <p className="text-sm text-gray-600">{orderProgress}% complete</p>
                {orderProgress === 100 && <p className="text-green-600 font-medium">Order placed successfully! ðŸŽ‰</p>}
              </div>
            ) : (
              <div>
                <p className="text-sm text-gray-600 mb-4">Items needed for your meal plan:</p>
                <div className="max-h-48 overflow-y-auto space-y-2">
                  {groceryItems.map((item, index) => (
                    <div key={index} className="flex items-center space-x-2 text-sm">
                      <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                      <span>{item}</span>
                    </div>
                  ))}
                </div>
                <div className="flex space-x-2 mt-4">
                  <Button onClick={orderGroceries} className="flex-1 bg-blue-600 hover:bg-blue-700">
                    Place Order with Kroger
                  </Button>
                  <Button variant="outline" onClick={() => window.open("https://www.kroger.com/cart", "_blank")} className="flex-1">
                    View Kroger Cart
                  </Button>
                </div>
              </div>
            )}
          </div>
        </DialogContent>
      </Dialog>
    </div>
  )
}
